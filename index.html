<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Chosen Palette: Verde Musgo & Fundo Verde Claro (com toques de verde e azul suaves) -->
    <!-- Application Structure Plan: A Single-Page Application (SPA) emulando uma interface de chat do WhatsApp. A estrutura é dividida em: 1. Cabeçalho Fixo: Estilizado como a barra superior do WhatsApp, com logo da loja, nome e status "Online". 2. Janela de Chat: Área principal rolável que exibe a conversa, com balões de mensagem de design suave e animações de carregamento amigáveis. 3. Área de Interação: Um campo de texto para entrada do usuário e botões de opção que aparecem dinamicamente para guiar o fluxo de pedidos, com um visual mais integrado e responsivo. 4. Resumo do Pedido: Uma seção que surge ao final do fluxo, detalhando o pedido com um layout de cartão, e um botão principal para enviar via WhatsApp. Esta estrutura foi escolhida para maximizar a familiaridade e a usabilidade, aproveitando o reconhecimento da interface do WhatsApp para guiar o usuário de forma eficaz e amigável. -->
    <!-- Visualization & Content Choices: A principal forma de apresentação é um fluxo de conversação (árvore de decisão). Objetivo: Guiar o pedido de forma familiar. Método: Balões de chat com texto e botões de múltipla escolha para itens (Sorvete, Picolé, Açaí, Milkshake, bases, sabores) e campo de texto para detalhes (Nome, Quantidade, Acompanhamentos de Açaí). Interação: Cliques nos botões e digitação no campo de texto. Justificativa: A interface de chat é inerentemente conversacional e a familiaridade com o WhatsApp reduz a curva de aprendizado. O resumo final do pedido é um bloco de texto formatado para clareza. Novas funcionalidades LLM: 1. Descrição de Produtos: O bot pode fornecer descrições detalhadas de sabores/itens usando LLM. Objetivo: Informar e engajar. Método: Resposta textual dinâmica. 2. Sugestão Criativa de Pedido: O bot pode sugerir combinações de produtos usando LLM. Objetivo: Engajar e facilitar a escolha. Método: Resposta textual dinâmica com opções de ação. Nenhuma biblioteca de gráficos (Chart.js, Plotly) é necessária, pois o foco é na interação conversacional e na simplicidade do pedido. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicias GELADA'S - Chatbot de Pedidos</title>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel from CDN for in-browser JSX transpilation -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Small adjustments for a better look */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom animation for loading dots */
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .animate-pulse-dot {
            animation: pulse-dot 1.4s infinite ease-in-out;
        }
        .animate-pulse-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .animate-pulse-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* WhatsApp-like message bubble tails */
        .message-tail-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -7px; /* Adjust as needed */
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-bottom: 10px solid #4A574F; /* Moss Green */
            border-top: 10px solid transparent;
            transform: skewX(-30deg); /* Creates the tail effect */
            border-bottom-right-radius: 5px; /* Smooth corner */
        }

        .message-tail-bot::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -7px; /* Adjust as needed */
            width: 0;
            height: 0;
            border-right: 10px solid transparent;
            border-bottom: 10px solid white; /* White bubble */
            border-top: 10px solid transparent;
            transform: skewX(30deg); /* Creates the tail effect */
            border-bottom-left-radius: 5px; /* Smooth corner */
        }

        /* WhatsApp-like chat background pattern */
        .chat-background {
            background-image: url('https://www.transparenttextures.com/patterns/clean-textile.png'); /* Subtle texture */
            background-color: #E0F0E0; /* Light Green BG */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // Main App component for the Ice Cream Shop Order Chatbot
        const App = () => {
            // State to store chat messages, including options for bot messages
            const [messages, setMessages] = React.useState([]);
            // State to store user input
            const [userInput, setUserInput] = React.useState('');
            // State to manage loading indicator for bot responses
            const [isLoading, setIsLoading] = React.useState(false);
            // State to hold the current order details
            const [currentOrder, setCurrentOrder] = React.useState({
                items: [],
                customerName: '',
                deliveryAddress: '',
                phoneNumber: '',
                isOrderComplete: false,
                currentItemType: '',
                currentItemBase: '', // For ice cream/popsicle base (Leite/Fruta)
                currentItemContainer: '', // For açaí container (Copo/Caixa)
                currentItemFlavor: '', // Base flavor/size of the current item
                currentItemPrice: 0, // Base price of the current item
                currentItemToppings: '', // Raw user input for açaí toppings
                currentItemToppingsPrice: 0, // Calculated price of açaí toppings
                currentItemTotalPrice: 0, // Total price for the current item being built
                currentItemQuantity: 0,
                paymentMethod: '', // New state for payment method
                finalOrderTotal: 0, // New state for final total including fees
                isDeliverySelected: false, // New state to track if delivery was chosen
                tempSelectedToppings: [], // Temporary array to hold selected toppings for açaí
            });
            // State to manage the conversation flow (decision tree states)
            const [conversationState, setConversationState] = React.useState('START');
            // Ref for scrolling to the latest message
            const messagesEndRef = React.useRef(null);

            // Placeholder for the WhatsApp number to send orders to
            const WHATSAPP_NUMBER = '5511963421674'; // Updated WhatsApp number

            // Data for açaí toppings
            const acaiToppings = [
                { name: 'Leite em Pó', price: '2,50' },
                { name: 'Leite Condensado', price: '2,50' },
                { name: 'Paçoca', price: '2,50' },
                { name: 'Granola', price: '3,00' },
                { name: 'Cobertura de Chocolate', price: '2,50' },
                { name: 'Cobertura de Morango', price: '2,50' },
                { name: 'Chocoball', price: '3,50' },
                { name: 'Ovomaltine', price: '4,00' },
            ];

            // Data for popsicle pricing tiers
            const popsicleTiers = [
                { min: 1, max: 29, price: 1.00 },
                { min: 30, max: 299, price: 0.85 },
                { min: 300, max: 999, price: 0.80 },
                { min: 1000, max: 1999, price: 0.75 },
                { min: 2000, max: Infinity, price: 0.70 },
            ];

            // Helper to parse price from string (e.g., "R$ 7,00")
            const getPriceFromString = (str) => {
                const match = str.match(/R\$ (\d+,\d{2})/);
                if (match) {
                    return parseFloat(match[1].replace(',', '.'));
                }
                return 0;
            };

            // Helper to calculate toppings price
            const calculateToppingsPrice = (toppingsArray, availableToppings) => {
                let totalToppingCost = 0;
                toppingsArray.forEach(selectedToppingName => {
                    const found = availableToppings.find(t => t.name === selectedToppingName);
                    if (found) {
                        totalToppingCost += parseFloat(found.price.replace(',', '.'));
                    }
                });
                return totalToppingCost;
            };

            // Helper to get popsicle unit price based on quantity
            const getPopsicleUnitPrice = (quantity) => {
                for (const tier of popsicleTiers) {
                    if (quantity >= tier.min && quantity <= tier.max) {
                        return tier.price;
                    }
                }
                return 1.00; // Default price if no tier matches (e.g., quantity 0 or negative, though validation should prevent this)
            };

            // Function to call Gemini LLM for dynamic responses
            const callGeminiLLM = async (promptText) => {
                let chatHistory = [];
                chatHistory.push({
                    role: "user",
                    parts: [{
                        text: `Você é um chatbot para a "Delicias GELADA'S". Responda de forma amigável e útil.
                        Informações da Delicias GELADA'S:
                        - Sorvetes: Leite (chocolate, creme, flocos), Fruta (morango, pistache, limão), de Massa (Tradicional, Especial, Trufado).
                        - Picolés: Leite (Abacaxi Suíço, Amendoim, Banana, Baunilha, Blue Ice, Bombom, Chiclete, Chocolate, Chocomenta, Coco Queimado, Chocolate Branco, Coco, Cookies, Flocos, Ice Ninho, Leite Condensado, Limão Suíço, Milho, Mousse de Maracujá, Morango), Fruta (Abacaxi, Açaí, Groselha, Limão, Manga, Maracujá, Melancia, Pinta Língua, Tangerina, Kiwi, Uva).
                        - Açaí: Copo (300ml - R$ 7,00, 500ml - R$ 10,00, 770ml - R$ 13,00), Caixa (2 litros - R$ 28,00, 5 litros - R$ 60,00, 10 litros - R$ 100,00). Acompanhamentos (Leite em Pó R$2,50, Leite Condensado R$2,50, Paçoca R$2,50, Granola R$3,00, Cobertura de Chocolate R$2,50, Cobertura de Morango R$2,50, Chocoball R$3,50, Ovomaltine R$4,00).
                        - Milkshakes: Baunilha, Morango, Chocolate, Oreo, Paçoca, Ovomaltine.

                        Sua tarefa é responder a pergunta do cliente ou gerar uma sugestão/descrição.
                        ${promptText}`
                    }]
                });

                const payload = { contents: chatHistory };
                const apiKey = ""; // API key will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    }
                    return "Desculpe, não consegui entender sua solicitação no momento.";
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    return "Desculpe, houve um erro ao processar sua solicitação. Por favor, tente novamente mais tarde.";
                }
            };


            // Scroll to the bottom of the chat when new messages arrive
            React.useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // Initial welcome message from the bot when the component mounts
            React.useEffect(() => {
                const startChat = async () => {
                    setConversationState('START');
                    const { botResponse, nextState, options } = await getBotResponse('', 'START');
                    setMessages([{ sender: 'bot', text: botResponse, options: options }]);
                    setConversationState(nextState);
                };
                startChat();
            }, []);

            // Function to determine bot response and next state based on current state and user input
            const getBotResponse = async (userText, state) => {
                let botResponse = '';
                let nextState = state;
                let options = []; // Options to be displayed as buttons

                // Handle "Voltar" option universally based on current state
                if (userText === 'Voltar ao Início') {
                    botResponse = 'Voltando ao início. O que você gostaria de fazer?';
                    options = ['Fazer um Pedido', 'Quero uma Sugestão ✨'];
                    nextState = 'SELECT_ACTION';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Tipo de Produto') {
                    botResponse = 'Voltando à seleção de tipo de produto. O que você gostaria de pedir?';
                    options = ['Sorvete de Massa', 'Picolé', 'Açaí', 'Milkshake', 'Voltar ao Início'];
                    nextState = 'SELECT_PRODUCT_TYPE';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Base de Sorvete') {
                    botResponse = 'Voltando para a seleção da base do sorvete. Qual tipo de sorvete você gostaria?';
                    options = ['Leite', 'Fruta', 'de Massa', 'Voltar para Tipo de Produto'];
                    nextState = 'SELECT_ICE_CREAM_BASE';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Base de Picolé') {
                    botResponse = 'Voltando para a seleção da base do picolé. Qual tipo de picolé você gostaria?';
                    options = ['Leite', 'Fruta', 'Voltar para Tipo de Produto'];
                    nextState = 'SELECT_POPSICLE_BASE';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Embalagem de Açaí') {
                    botResponse = 'Voltando para a seleção da embalagem do açaí. Você gostaria de açaí em Copo ou Caixa?';
                    options = ['Copo', 'Caixa', 'Voltar para Tipo de Produto'];
                    nextState = 'SELECT_ACAI_CONTAINER';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Tamanho do Açaí') {
                    botResponse = 'Voltando para a seleção do tamanho do açaí em Copo. Qual tamanho você gostaria?';
                    options = ['300ml - R$ 7,00', '500ml - R$ 10,00', '770ml - R$ 13,00', 'Voltar para Embalagem de Açaí'];
                    nextState = 'SELECT_ACAI_SIZE';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Acompanhamentos do Açaí') {
                    // Reset tempSelectedToppings when coming back to this state
                    setCurrentOrder(prev => ({ ...prev, tempSelectedToppings: [] }));
                    let toppingsListText = 'Voltando para escolher acompanhamentos do açaí. Quais acompanhamentos você gostaria? (Selecione um por vez)\n\nDisponíveis:\n';
                    acaiToppings.forEach(topping => {
                        toppingsListText += `- ${topping.name} R$ ${topping.price}\n`;
                    });
                    toppingsListText += '\nQuando terminar, clique em "Finalizar Acompanhamentos" ou "Nenhum" se não quiser.';
                    options = acaiToppings.map(t => t.name).concat(['Finalizar Acompanhamentos', 'Nenhum', 'Voltar para Embalagem de Açaí']);
                    nextState = 'COLLECT_ACAI_TOPPINGS';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Tamanho da Caixa de Açaí') {
                    botResponse = 'Voltando para a seleção do tamanho da caixa de açaí. Qual tamanho você gostaria?';
                    options = ['2 litros - R$ 28,00', '5 litros - R$ 60,00', '10 litros - R$ 100,00', 'Voltar para Embalagem de Açaí'];
                    nextState = 'SELECT_ACAI_BOX_SIZE';
                    return { botResponse, nextState, options };
                }
                 else if (userText === 'Voltar à Seleção de Sabor/Acompanhamento') {
                    if (currentOrder.currentItemType === 'Açaí') {
                        botResponse = 'Voltando para escolher acompanhamentos do açaí. Quais acompanhamentos você gostaria?';
                        nextState = 'COLLECT_ACAI_TOPPINGS';
                    } else if (currentOrder.currentItemType === 'Sorvete' && currentOrder.currentItemBase === 'de Massa') {
                        botResponse = 'Voltando para a seleção do tipo de sorvete de massa. Qual tipo de sorvete de massa você gostaria?';
                        options = ['Tradicional', 'Especial', 'Trufado', 'Voltar para Base de Sorvete'];
                        nextState = 'SELECT_ICE_CREAM_MASS_TYPE';
                    }
                    else {
                        botResponse = `Voltando para escolher o sabor de ${currentOrder.currentItemType}. Qual sabor você gostaria?`;
                        if (currentOrder.currentItemType === 'Sorvete') {
                            options = (currentOrder.currentItemBase === 'Leite') ? ['Chocolate', 'Creme', 'Flocos'] : ['Morango', 'Pistache', 'Limão'];
                        } else if (currentOrder.currentItemType === 'Picolé') {
                            options = (currentOrder.currentItemBase === 'Leite') ? ['Abacaxi Suíço', 'Amendoim', 'Banana', 'Baunilha', 'Blue Ice', 'Bombom', 'Chiclete', 'Chocolate', 'Chocomenta', 'Coco Queimado', 'Chocolate Branco', 'Coco', 'Cookies', 'Flocos', 'Ice Ninho', 'Leite Condensado', 'Limão Suíço', 'Milho', 'Mousse de Maracujá', 'Morango'] : ['Abacaxi', 'Açaí', 'Groselha', 'Limão', 'Manga', 'Maracujá', 'Melancia', 'Pinta Língua', 'Tangerina', 'Kiwi', 'Uva'];
                        } else if (currentOrder.currentItemType === 'Milkshake') {
                            options = ['Baunilha', 'Morango', 'Chocolate', 'Oreo', 'Paçoca', 'Ovomaltine'];
                        }
                        nextState = 'SELECT_FLAVOR';
                    }
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Adicionar Itens') {
                    botResponse = 'Voltando para a opção de adicionar mais itens. Deseja adicionar mais itens ao seu pedido?';
                    options = ['Sim', 'Não'];
                    nextState = 'ADD_MORE_ITEMS';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Coletar Nome') {
                    botResponse = 'Voltando para a coleta do seu nome. Qual é o seu nome completo?';
                    nextState = 'COLLECT_NAME';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Opção de Entrega') {
                    botResponse = 'Voltando para a opção de entrega/retirada. Você gostaria de entrega ou retirada na loja?';
                    options = ['Entrega', 'Retirada na Loja'];
                    nextState = 'COLLECT_DELIVERY_OPTION';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Coletar Endereço') {
                    botResponse = 'Voltando para a coleta do endereço. Por favor, informe o endereço completo para entrega.';
                    nextState = 'COLLECT_ADDRESS';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Coletar Telefone') {
                    botResponse = 'Voltando para a coleta do telefone. Qual é o seu número de telefone para contato?';
                    nextState = 'COLLECT_PHONE';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Confirmação do Pedido') {
                    botResponse = 'Voltando para a confirmação do pedido. Deseja confirmar ou fazer alguma alteração?';
                    options = ['Confirmar Pedido', 'Editar Pedido', 'Cancelar Pedido', 'Voltar para Coletar Telefone'];
                    nextState = 'ORDER_CONFIRMATION_ACTION';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Forma de Pagamento') {
                    botResponse = `Qual a forma de pagamento?`;
                    options = ['Pix', 'Débito', 'Crédito', 'Dinheiro', 'Voltar para Confirmação do Pedido'];
                    nextState = 'SELECT_PAYMENT_METHOD';
                    return { botResponse, nextState, options };
                } else if (userText === 'Voltar para Tipo de Sorvete de Massa') {
                    botResponse = 'Voltando para a seleção do tipo de sorvete de massa. Qual tipo de sorvete de massa você gostaria?';
                    options = ['Tradicional', 'Especial', 'Trufado', 'Voltar para Base de Sorvete'];
                    nextState = 'SELECT_ICE_CREAM_MASS_TYPE';
                    return { botResponse, nextState, options };
                }

                // --- LLM-powered features ---
                if (userText.toLowerCase().startsWith('descreva ') || userText.toLowerCase().startsWith('o que é ')) {
                    const itemToDescribe = userText.toLowerCase().replace('descreva ', '').replace('o que é ', '').trim();
                    const llmDescription = await callGeminiLLM(`Crie uma descrição curta e apetitosa para o sabor/item "${itemToDescribe}" da Delicias GELADA'S.`);
                    botResponse = `${llmDescription}\n\nPosso ajudar com mais alguma coisa?`;
                    options = ['Fazer um Pedido', 'Quero uma Sugestão ✨']; // Removed Calcular Frete
                    nextState = 'SELECT_ACTION';
                    return { botResponse, nextState, options };
                } else if (userText === 'Quero uma Sugestão ✨') {
                    const llmSuggestion = await callGeminiLLM('Sugira uma combinação criativa de sorvete, picolé ou açaí da Delicias GELADA\'S para alguém que busca algo delicioso. Inclua sabor, base (se aplicável) e 1-2 acompanhamentos.');
                    botResponse = `Que tal isso? ${llmSuggestion}\n\nGostaria de pedir isso ou outra sugestão?`;
                    options = ['Pedir Sugestão', 'Outra Sugestão', 'Voltar ao Início'];
                    nextState = 'SUGGEST_ORDER_ACTION';
                    return { botResponse, nextState, options };
                }

                switch (state) {
                    case 'START':
                        botResponse = 'Olá! Bem-vindo(a) à Delicias GELADA\'S. O que você gostaria de fazer?';
                        options = ['Fazer um Pedido', 'Quero uma Sugestão ✨']; // Removed Calcular Frete
                        nextState = 'SELECT_ACTION';
                        break;

                    case 'SELECT_ACTION':
                        if (userText === 'Fazer um Pedido') {
                            botResponse = 'Ótimo! O que você gostaria de pedir?';
                            options = ['Sorvete de Massa', 'Picolé', 'Açaí', 'Milkshake', 'Voltar ao Início'];
                            nextState = 'SELECT_PRODUCT_TYPE';
                        } else { // Removed 'Calcular Frete' case
                            botResponse = 'Desculpe, não entendi. Por favor, escolha uma das opções.';
                            options = ['Fazer um Pedido', 'Quero uma Sugestão ✨']; // Removed Calcular Frete
                            nextState = 'SELECT_ACTION';
                        }
                        break;

                    case 'SUGGEST_ORDER_ACTION':
                        if (userText === 'Pedir Sugestão') {
                            botResponse = 'Ótimo! Para prosseguir com essa sugestão, por favor, me diga o nome do produto principal (ex: "Sorvete", "Picolé", "Açaí") e o sabor/combinação para que eu possa adicioná-lo ao seu pedido.';
                            nextState = 'SELECT_PRODUCT_TYPE'; // User will manually input the suggested item
                        } else if (userText === 'Outra Sugestão') {
                            const llmSuggestion = await callGeminiLLM('Sugira outra combinação criativa de sorvete, picolé ou açaí da Delicias GELADA\'S para alguém que busca algo delicioso. Inclua sabor, base (se aplicável) e 1-2 acompanhamentos.');
                            botResponse = `Que tal esta? ${llmSuggestion}\n\nGostaria de pedir isso ou outra sugestão?`;
                            options = ['Pedir Sugestão', 'Outra Sugestão', 'Voltar ao Início'];
                            nextState = 'SUGGEST_ORDER_ACTION';
                        } else {
                            botResponse = 'Por favor, escolha uma das opções.';
                            options = ['Pedir Sugestão', 'Outra Sugestão', 'Voltar ao Início'];
                            nextState = 'SUGGEST_ORDER_ACTION';
                        }
                        break;

                    case 'SELECT_PRODUCT_TYPE':
                        if (userText === 'Sorvete de Massa') {
                            botResponse = 'Qual tipo de sorvete de massa você gostaria?';
                            options = ['Tradicional', 'Especial', 'Trufado', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_ICE_CREAM_MASS_TYPE';
                            setCurrentOrder(prev => ({ ...prev, currentItemType: 'Sorvete', currentItemBase: 'de Massa', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, tempSelectedToppings: [] })); // Reset all item-related states
                        } else if (userText === 'Picolé') {
                            botResponse = 'Qual tipo de picolé você gostaria?';
                            options = ['Leite', 'Fruta', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_POPSICLE_BASE';
                            setCurrentOrder(prev => ({ ...prev, currentItemType: userText, currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, tempSelectedToppings: [] })); // Reset all item-related states
                        } else if (userText === 'Açaí') {
                            botResponse = 'Você gostaria de açaí em Copo ou Caixa?';
                            options = ['Copo', 'Caixa', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_ACAI_CONTAINER';
                            setCurrentOrder(prev => ({ ...prev, currentItemType: userText, currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, tempSelectedToppings: [] })); // Reset all item-related states
                        } else if (userText === 'Milkshake') {
                            botResponse = 'Qual sabor de milkshake você gostaria?';
                            options = ['Baunilha', 'Morango', 'Chocolate', 'Oreo', 'Paçoca', 'Ovomaltine', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_FLAVOR';
                            setCurrentOrder(prev => ({ ...prev, currentItemType: userText, currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, tempSelectedToppings: [] })); // Reset all item-related states
                        } else {
                            botResponse = 'Por favor, escolha um tipo de produto válido.';
                            options = ['Sorvete de Massa', 'Picolé', 'Açaí', 'Milkshake', 'Voltar ao Início'];
                            nextState = 'SELECT_PRODUCT_TYPE';
                        }
                        break;

                    case 'SELECT_ICE_CREAM_BASE':
                        if (userText === 'Leite') {
                            setCurrentOrder(prev => ({ ...prev, currentItemBase: userText }));
                            botResponse = 'Qual sabor de sorvete de leite você gostaria?';
                            options = ['Chocolate', 'Creme', 'Flocos', 'Voltar para Base de Sorvete'];
                            nextState = 'SELECT_FLAVOR';
                        } else if (userText === 'Fruta') {
                            setCurrentOrder(prev => ({ ...prev, currentItemBase: userText }));
                            botResponse = 'Qual sabor de sorvete de fruta você gostaria?';
                            options = ['Morango', 'Pistache', 'Limão', 'Voltar para Base de Sorvete'];
                            nextState = 'SELECT_FLAVOR';
                        } else if (userText === 'de Massa') {
                            setCurrentOrder(prev => ({ ...prev, currentItemBase: userText }));
                            botResponse = 'Qual tipo de sorvete de massa você gostaria?';
                            options = ['Tradicional', 'Especial', 'Trufado', 'Voltar para Base de Sorvete'];
                            nextState = 'SELECT_ICE_CREAM_MASS_TYPE';
                        }
                        else {
                            botResponse = 'Por favor, escolha um tipo válido (Leite, Fruta ou de Massa).';
                            options = ['Leite', 'Fruta', 'de Massa', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_ICE_CREAM_BASE';
                        }
                        break;

                    case 'SELECT_ICE_CREAM_MASS_TYPE':
                        if (userText === 'Tradicional') {
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: `de Massa ${userText}`, currentItemPrice: 14.00 }));
                            botResponse = `Qual sabor de sorvete de massa ${userText} você gostaria?`;
                            options = ['Chocolate', 'Creme', 'Morango', 'Voltar para Tipo de Sorvete de Massa'];
                            nextState = 'SELECT_FLAVOR';
                        } else if (userText === 'Especial') {
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: `de Massa ${userText}`, currentItemPrice: 15.00 }));
                            botResponse = `Qual sabor de sorvete de massa ${userText} você gostaria?`;
                            options = ['Flocos', 'Galak', 'Sensação', 'Chocomenta', 'Voltar para Tipo de Sorvete de Massa'];
                            nextState = 'SELECT_FLAVOR';
                        }
                        else if (userText === 'Trufado') {
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: `de Massa ${userText}`, currentItemPrice: 16.00 }));
                            botResponse = `Qual sabor de sorvete de massa ${userText} você gostaria?`;
                            options = ['Ninho Trufado', 'Abacaxi ao Vinho', 'Iogurte Frutas Vermelhas', 'Torta de Limão', 'Voltar para Tipo de Sorvete de Massa'];
                            nextState = 'SELECT_FLAVOR';
                        } else {
                            botResponse = 'Por favor, escolha um tipo válido (Tradicional, Especial ou Trufado).';
                            options = ['Tradicional', 'Especial', 'Trufado', 'Voltar para Base de Sorvete'];
                            nextState = 'SELECT_ICE_CREAM_MASS_TYPE';
                        }
                        break;

                    case 'SELECT_POPSICLE_BASE':
                        if (userText === 'Leite') {
                            setCurrentOrder(prev => ({ ...prev, currentItemBase: userText }));
                            botResponse = 'Qual sabor de picolé de leite você gostaria?';
                            options = ['Abacaxi Suíço', 'Amendoim', 'Banana', 'Baunilha', 'Blue Ice', 'Bombom', 'Chiclete', 'Chocolate', 'Chocomenta', 'Coco Queimado', 'Chocolate Branco', 'Coco', 'Cookies', 'Flocos', 'Ice Ninho', 'Leite Condensado', 'Limão Suíço', 'Milho', 'Mousse de Maracujá', 'Morango', 'Voltar para Base de Picolé'];
                            nextState = 'SELECT_FLAVOR';
                        } else if (userText === 'Fruta') {
                            setCurrentOrder(prev => ({ ...prev, currentItemBase: userText }));
                            botResponse = 'Qual sabor de picolé de fruta você gostaria?';
                            options = ['Abacaxi', 'Açaí', 'Groselha', 'Limão', 'Manga', 'Maracujá', 'Melancia', 'Pinta Língua', 'Tangerina', 'Kiwi', 'Uva', 'Voltar para Base de Picolé'];
                            nextState = 'SELECT_FLAVOR';
                        } else {
                            botResponse = 'Por favor, escolha um tipo válido (Leite ou Fruta).';
                            options = ['Leite', 'Fruta', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_POPSICLE_BASE';
                        }
                        break;

                    case 'SELECT_ACAI_CONTAINER':
                        if (userText === 'Copo') {
                            setCurrentOrder(prev => ({ ...prev, currentItemContainer: userText, tempSelectedToppings: [] })); // Reset temp toppings
                            botResponse = 'Qual tamanho de açaí em Copo você gostaria?';
                            options = ['300ml - R$ 7,00', '500ml - R$ 10,00', '770ml - R$ 13,00', 'Voltar para Embalagem de Açaí'];
                            nextState = 'SELECT_ACAI_SIZE';
                        } else if (userText === 'Caixa') {
                            setCurrentOrder(prev => ({ ...prev, currentItemContainer: userText, currentItemFlavor: `${userText}`, currentItemPrice: 0 })); // Set flavor for Caixa directly and reset price
                            botResponse = `Qual tamanho de açaí em Caixa você gostaria?`;
                            options = ['2 litros - R$ 28,00', '5 litros - R$ 60,00', '10 litros - R$ 100,00', 'Voltar para Embalagem de Açaí'];
                            nextState = 'SELECT_ACAI_BOX_SIZE'; // New state for box size selection
                        } else {
                            botResponse = 'Por favor, escolha "Copo" ou "Caixa".';
                            options = ['Copo', 'Caixa', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_ACAI_CONTAINER';
                        }
                        break;

                    case 'SELECT_ACAI_SIZE':
                        const validAcaiSizes = ['300ml - R$ 7,00', '500ml - R$ 10,00', '770ml - R$ 13,00'];
                        if (validAcaiSizes.includes(userText)) {
                            const basePrice = getPriceFromString(userText);
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: `${currentOrder.currentItemContainer} ${userText}`, currentItemPrice: basePrice, currentItemTotalPrice: basePrice, tempSelectedToppings: [] })); // Set base flavor with container and size, and its price, and total price for cup
                            
                            let toppingsListText = 'Ótimo! Quais acompanhamentos você gostaria? (Selecione um por vez)\n\nDisponíveis:\n';
                            acaiToppings.forEach(topping => {
                                toppingsListText += `- ${topping.name} R$ ${topping.price}\n`;
                            });
                            toppingsListText += '\nQuando terminar, clique em "Finalizar Acompanhamentos" ou "Nenhum" se não quiser.';

                            botResponse = toppingsListText;
                            options = acaiToppings.map(t => t.name).concat(['Finalizar Acompanhamentos', 'Nenhum', 'Voltar para Embalagem de Açaí']);
                            nextState = 'COLLECT_ACAI_TOPPINGS';
                        } else {
                            botResponse = 'Por favor, escolha um tamanho válido.';
                            options = ['300ml - R$ 7,00', '500ml - R$ 10,00', '770ml - R$ 13,00', 'Voltar para Embalagem de Açaí'];
                            nextState = 'SELECT_ACAI_SIZE';
                        }
                        break;

                    case 'SELECT_ACAI_BOX_SIZE': // New state for açaí box sizes
                        const validAcaiBoxSizes = ['2 litros - R$ 28,00', '5 litros - R$ 60,00', '10 litros - R$ 100,00'];
                        if (validAcaiBoxSizes.includes(userText)) {
                            const basePrice = getPriceFromString(userText);
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: `${currentOrder.currentItemContainer} ${userText}`, currentItemPrice: basePrice, currentItemTotalPrice: basePrice })); // Set flavor and price, and total price for box
                            
                            // For box açaí, we will now skip toppings and go directly to quantity
                            botResponse = `Quantos açaís ${currentOrder.currentItemFlavor} você gostaria? (Digite a quantidade)`;
                            nextState = 'SELECT_QUANTITY';
                        } else {
                            botResponse = 'Por favor, escolha um tamanho de caixa válido.';
                            options = ['2 litros - R$ 28,00', '5 litros - R$ 60,00', '10 litros - R$ 100,00', 'Voltar para Embalagem de Açaí'];
                            nextState = 'SELECT_ACAI_BOX_SIZE';
                        }
                        break;
                    
                    case 'SELECT_FLAVOR':
                        let validFlavors = [];
                        if (currentOrder.currentItemType === 'Sorvete') {
                            if (currentOrder.currentItemBase === 'Leite') {
                                validFlavors = ['Chocolate', 'Creme', 'Flocos'];
                            } else if (currentOrder.currentItemBase === 'Fruta') {
                                validFlavors = ['Morango', 'Pistache', 'Limão'];
                            } else if (currentOrder.currentItemBase === 'de Massa') {
                                if (currentOrder.currentItemPrice === 14.00) { // Tradicional
                                    validFlavors = ['Chocolate', 'Creme', 'Morango'];
                                } else if (currentOrder.currentItemPrice === 15.00) { // Especial
                                    validFlavors = ['Flocos', 'Galak', 'Sensação', 'Chocomenta'];
                                } else if (currentOrder.currentItemPrice === 16.00) { // Trufado
                                    validFlavors = ['Ninho Trufado', 'Abacaxi ao Vinho', 'Iogurte Frutas Vermelhas', 'Torta de Limão'];
                                }
                            }
                        } else if (currentOrder.currentItemType === 'Picolé') {
                            if (currentOrder.currentItemBase === 'Leite') {
                                validFlavors = ['Abacaxi Suíço', 'Amendoim', 'Banana', 'Baunilha', 'Blue Ice', 'Bombom', 'Chiclete', 'Chocolate', 'Chocomenta', 'Coco Queimado', 'Chocolate Branco', 'Coco', 'Cookies', 'Flocos', 'Ice Ninho', 'Leite Condensado', 'Limão Suíço', 'Milho', 'Mousse de Maracujá', 'Morango'];
                            } else if (currentOrder.currentItemBase === 'Fruta') {
                                validFlavors = ['Abacaxi', 'Açaí', 'Groselha', 'Limão', 'Manga', 'Maracujá', 'Melancia', 'Pinta Língua', 'Tangerina', 'Kiwi', 'Uva'];
                            }
                        } else if (currentOrder.currentItemType === 'Milkshake') {
                            validFlavors = ['Baunilha', 'Morango', 'Chocolate', 'Oreo', 'Paçoca', 'Ovomaltine'];
                        }

                        if (validFlavors.includes(userText)) {
                            setCurrentOrder(prev => ({ ...prev, currentItemFlavor: userText }));
                            botResponse = `Quantos de ${currentOrder.currentItemType} de ${userText} você gostaria? (Digite a quantidade)`;
                            nextState = 'SELECT_QUANTITY';
                        } else {
                            let backOption = '';
                            if (currentOrder.currentItemType === 'Sorvete') {
                                if (currentOrder.currentItemBase === 'de Massa') {
                                    backOption = 'Voltar para Tipo de Sorvete de Massa';
                                } else {
                                    backOption = 'Voltar para Base de Sorvete';
                                }
                            } else if (currentOrder.currentItemType === 'Picolé') {
                                backOption = 'Voltar para Base de Picolé';
                            } else if (currentOrder.currentItemType === 'Açaí') {
                                backOption = 'Voltar para Embalagem de Açaí';
                            } else {
                                backOption = 'Voltar para Tipo de Produto';
                            }
                            botResponse = `Sabor inválido para ${currentOrder.currentItemType} de ${currentOrder.currentItemBase || ''}. Por favor, escolha um dos sabores disponíveis: ${validFlavors.join(', ')}.`;
                            options = [...validFlavors, backOption];
                            nextState = 'SELECT_FLAVOR';
                        }
                        break;

                    case 'COLLECT_ACAI_TOPPINGS': // This state now handles button clicks for toppings
                        const isToppingSelected = acaiToppings.map(t => t.name).includes(userText);
                        const isFinalizingToppings = userText === 'Finalizar Acompanhamentos';
                        const isNoToppings = userText === 'Nenhum';

                        let currentTempToppings = currentOrder.tempSelectedToppings;

                        if (isToppingSelected) {
                            if (!currentTempToppings.includes(userText)) {
                                currentTempToppings = [...currentTempToppings, userText];
                                setCurrentOrder(prev => ({
                                    ...prev,
                                    tempSelectedToppings: currentTempToppings,
                                }));
                                botResponse = `"${userText}" adicionado.`;
                            } else {
                                // If already selected, allow deselection
                                currentTempToppings = currentTempToppings.filter(t => t !== userText);
                                setCurrentOrder(prev => ({
                                    ...prev,
                                    tempSelectedToppings: currentTempToppings,
                                }));
                                botResponse = `"${userText}" removido.`;
                            }
                            // Re-list all toppings, but visually indicate selected ones
                            options = acaiToppings.map(t => t.name).concat(['Finalizar Acompanhamentos', 'Nenhum', 'Voltar para Embalagem de Açaí']);
                            nextState = 'COLLECT_ACAI_TOPPINGS'; // Stay in this state
                        } else if (isFinalizingToppings || isNoToppings) {
                            const selectedToppingsArray = currentTempToppings; // Use the accumulated toppings
                            const selectedToppingsText = isNoToppings ? 'sem acompanhamentos' : (selectedToppingsArray.length > 0 ? `com ${selectedToppingsArray.join(', ')}` : 'sem acompanhamentos');
                            const toppingsCost = isNoToppings ? 0 : calculateToppingsPrice(selectedToppingsArray, acaiToppings);
                            
                            const currentItemTotal = currentOrder.currentItemPrice + toppingsCost;

                            setCurrentOrder(prev => ({
                                ...prev,
                                currentItemToppings: selectedToppingsText,
                                currentItemToppingsPrice: toppingsCost,
                                currentItemTotalPrice: currentItemTotal,
                                tempSelectedToppings: [], // Clear temporary toppings after finalizing
                            }));

                            botResponse = `Confirmando: Seu açaí ${currentOrder.currentItemFlavor} ${selectedToppingsText} custará R$ ${currentItemTotal.toFixed(2).replace('.', ',')}. Confirma?`;
                            options = ['Sim', 'Não', 'Voltar para Acompanhamentos do Açaí'];
                            nextState = 'CONFIRM_ACAI_FINAL_ITEM';
                        } else {
                            botResponse = 'Opção inválida. Por favor, selecione um acompanhamento ou "Finalizar Acompanhamentos".';
                            options = acaiToppings.map(t => t.name).concat(['Finalizar Acompanhamentos', 'Nenhum', 'Voltar para Embalagem de Açaí']);
                            nextState = 'COLLECT_ACAI_TOPPINGS';
                        }
                        break;

                    case 'CONFIRM_ACAI_FINAL_ITEM': // This state is used for both cup and box açaí confirmation
                        if (userText === 'Sim') {
                            botResponse = `Quantos açaís ${currentOrder.currentItemFlavor} ${currentOrder.currentItemToppings} você gostaria? (Digite a quantidade)`;
                            nextState = 'SELECT_QUANTITY';
                        } else if (userText === 'Não') {
                            botResponse = 'Ok. Deseja mudar os acompanhamentos ou recomeçar a escolha do açaí?';
                            options = ['Mudar acompanhamentos', 'Recomeçar açaí', 'Voltar para Embalagem de Açaí'];
                            nextState = 'REVISE_ACAI_ITEM';
                        } else {
                            botResponse = 'Por favor, responda "Sim" ou "Não".';
                            options = ['Sim', 'Não', 'Voltar para Acompanhamentos do Açaí'];
                            nextState = 'CONFIRM_ACAI_FINAL_ITEM';
                        }
                        break;

                    case 'REVISE_ACAI_ITEM':
                        if (userText === 'Mudar acompanhamentos') {
                            // Reset tempSelectedToppings when coming back to this state
                            setCurrentOrder(prev => ({ ...prev, tempSelectedToppings: [] }));
                            let toppingsListText = 'Quais acompanhamentos você gostaria? (Selecione um por vez)\n\nDisponíveis:\n';
                            acaiToppings.forEach(topping => {
                                toppingsListText += `- ${topping.name} R$ ${topping.price}\n`;
                            });
                            toppingsListText += '\nQuando terminar, clique em "Finalizar Acompanhamentos" ou "Nenhum" se não quiser.';
                            botResponse = toppingsListText;
                            options = acaiToppings.map(t => t.name).concat(['Finalizar Acompanhamentos', 'Nenhum', 'Voltar para Embalagem de Açaí']);
                            nextState = 'COLLECT_ACAI_TOPPINGS';
                        } else if (userText === 'Recomeçar açaí') {
                            botResponse = 'Certo, vamos recomeçar a escolha do açaí. Você gostaria de açaí em Copo ou Caixa?';
                            options = ['Copo', 'Caixa', 'Voltar para Tipo de Produto'];
                            nextState = 'SELECT_ACAI_CONTAINER';
                            setCurrentOrder(prev => ({ ...prev, currentItemType: 'Açaí', currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, tempSelectedToppings: [] })); // Reset açaí-related states
                        } else {
                            botResponse = 'Por favor, escolha uma das opções.';
                            options = ['Mudar acompanhamentos', 'Recomeçar açaí', 'Voltar para Embalagem de Açaí'];
                            nextState = 'REVISE_ACAI_ITEM';
                        }
                        break;

                    case 'SELECT_QUANTITY':
                        const quantity = parseInt(userText);
                        if (!isNaN(quantity) && quantity > 0) {
                            let unitPrice = 0;
                            if (currentOrder.currentItemType === 'Picolé') {
                                unitPrice = getPopsicleUnitPrice(quantity);
                            } else if (currentOrder.currentItemType === 'Açaí') {
                                unitPrice = currentOrder.currentItemTotalPrice; // Açaí total price already calculated with toppings
                            } else if (currentOrder.currentItemType === 'Sorvete' && currentOrder.currentItemBase === 'de Massa') {
                                unitPrice = currentOrder.currentItemPrice; // Use the price set for Tradicional, Especial, Trufado
                            }
                            // For other items like Sorvete/Milkshake, you would define their unit prices here if needed
                            // For now, they don't have specific pricing logic like açaí or popsicles.

                            const newItem = {
                                produto: currentOrder.currentItemType,
                                sabor: currentOrder.currentItemFlavor + (currentOrder.currentItemToppings && currentOrder.currentItemType === 'Açaí' && currentOrder.currentItemContainer === 'Copo' ? ` ${currentOrder.currentItemToppings}` : ''), // Include toppings in flavor for Açaí Copo only
                                quantidade: quantity,
                                precoUnitario: unitPrice > 0 ? unitPrice : null, // Store unit price if calculated
                            };
                            setCurrentOrder(prev => ({
                                ...prev,
                                items: [...prev.items, newItem],
                                currentItemType: '',
                                currentItemBase: '', // Reset base
                                currentItemContainer: '', // Reset container
                                currentItemFlavor: '',
                                currentItemPrice: 0,
                                currentItemToppings: '',
                                currentItemToppingsPrice: 0,
                                currentItemTotalPrice: 0,
                                currentItemQuantity: 0,
                                tempSelectedToppings: [], // Reset temp toppings
                            }));
                            botResponse = 'Item adicionado! Deseja adicionar mais itens ao seu pedido?';
                            options = ['Sim', 'Não', 'Voltar para Adicionar Itens'];
                            nextState = 'ADD_MORE_ITEMS';
                        } else {
                            botResponse = 'Por favor, digite uma quantidade válida (um número maior que zero).';
                            nextState = 'SELECT_QUANTITY';
                        }
                        break;

                    case 'ADD_MORE_ITEMS':
                        if (userText === 'Sim') {
                            botResponse = 'O que mais você gostaria de pedir?';
                            options = ['Sorvete de Massa', 'Picolé', 'Açaí', 'Milkshake', 'Voltar ao Início'];
                            nextState = 'SELECT_PRODUCT_TYPE';
                        } else if (userText === 'Não') {
                            botResponse = 'Certo. Qual é o seu nome completo?';
                            nextState = 'COLLECT_NAME';
                        } else {
                            botResponse = 'Por favor, escolha "Sim" ou "Não".';
                            options = ['Sim', 'Não', 'Voltar para Tipo de Produto'];
                            nextState = 'ADD_MORE_ITEMS';
                        }
                        break;

                    case 'COLLECT_NAME':
                        setCurrentOrder(prev => ({ ...prev, customerName: userText }));
                        botResponse = 'Você gostaria de entrega ou retirada na loja?';
                        options = ['Entrega', 'Retirada na Loja', 'Voltar para Coletar Nome'];
                        nextState = 'COLLECT_DELIVERY_OPTION';
                        break;

                    case 'COLLECT_DELIVERY_OPTION':
                        if (userText === 'Entrega') {
                            setCurrentOrder(prev => ({ ...prev, isDeliverySelected: true })); // Set delivery flag
                            botResponse = 'Por favor, informe o endereço completo para entrega.';
                            nextState = 'COLLECT_DELIVERY_ADDRESS'; // New state for address input
                        } else if (userText === 'Retirada na Loja') {
                            setCurrentOrder(prev => ({ ...prev, deliveryAddress: 'Retirada na Loja', isDeliverySelected: false })); // Clear delivery flag
                            botResponse = 'Qual é o seu número de telefone para contato?';
                            nextState = 'COLLECT_PHONE';
                        } else {
                            botResponse = 'Por favor, escolha "Entrega" ou "Retirada na Loja".';
                            options = ['Entrega', 'Retirada na Loja', 'Voltar para Coletar Nome'];
                            nextState = 'COLLECT_DELIVERY_OPTION';
                        }
                        break;

                    case 'COLLECT_DELIVERY_ADDRESS': // New state to collect address
                        setCurrentOrder(prev => ({ ...prev, deliveryAddress: userText }));
                        botResponse = 'Qual é o seu número de telefone para contato?';
                        options = ['Voltar para Opção de Entrega']; // Option to go back to delivery choice
                        nextState = 'COLLECT_PHONE';
                        break;

                    case 'COLLECT_PHONE':
                        // Validate if input is purely numeric and has between 9 and 12 digits
                        const phoneNumber = userText.trim();
                        if (/^\d{9,12}$/.test(phoneNumber)) { // Regex to check for 9 to 12 digits
                            // Calculate subtotal before asking for payment method
                            const subtotal = currentOrder.items.reduce((acc, item) => acc + (item.quantidade * (item.precoUnitario || 0)), 0);
                            setCurrentOrder(prev => ({ ...prev, phoneNumber: phoneNumber, finalOrderTotal: subtotal }));

                            botResponse = `Qual a forma de pagamento?`;
                            options = ['Pix', 'Débito', 'Crédito', 'Dinheiro', 'Voltar para Coletar Telefone'];
                            nextState = 'SELECT_PAYMENT_METHOD';
                        } else {
                            botResponse = 'Por favor, digite um número de telefone válido, contendo apenas dígitos (mínimo 9, máximo 12).';
                            nextState = 'COLLECT_PHONE'; // Stay in the same state to re-collect input
                        }
                        break;
                    
                    case 'SELECT_PAYMENT_METHOD':
                        let paymentFee = 0;
                        let paymentDetails = '';
                        let finalTotal = currentOrder.finalOrderTotal;

                        if (userText === 'Débito') {
                            paymentFee = currentOrder.finalOrderTotal * 0.02;
                            finalTotal += paymentFee;
                            paymentDetails = ` (acréscimo de 2% pela taxa da máquina do cartão)`;
                        } else if (userText === 'Crédito') {
                            paymentFee = currentOrder.finalOrderTotal * 0.06;
                            finalTotal += paymentFee;
                            paymentDetails = ` (acréscimo de 6% pela taxa da máquina do cartão)`;
                        } else if (!['Pix', 'Dinheiro'].includes(userText)) {
                            botResponse = 'Por favor, escolha uma forma de pagamento válida.';
                            options = ['Pix', 'Débito', 'Crédito', 'Dinheiro', 'Voltar para Coletar Telefone']; // Changed back option
                            nextState = 'SELECT_PAYMENT_METHOD';
                            return { botResponse, nextState, options };
                        }

                        setCurrentOrder(prev => ({
                            ...prev,
                            paymentMethod: userText,
                            finalOrderTotal: finalTotal,
                            isOrderComplete: true, // Order is now complete after payment method selection
                        }));

                        botResponse = `Confirmado: Forma de pagamento ${userText}. O valor total do seu pedido será de R$ ${finalTotal.toFixed(2).replace('.', ',')}${paymentDetails}. Confirma o valor e forma de pagamento?`;
                        options = ['Sim, confirmar pagamento', 'Não, escolher outra forma', 'Voltar para Coletar Telefone']; // Changed back option
                        nextState = 'CONFIRM_FINAL_PAYMENT';
                        break;

                    case 'CONFIRM_FINAL_PAYMENT':
                        if (userText === 'Sim, confirmar pagamento') {
                            botResponse = 'Ótimo! Seu pedido está pronto para ser enviado. Clique no botão abaixo para finalizar.';
                            nextState = 'ORDER_CONFIRMATION'; // Now this is the final display state
                        } else if (userText === 'Não, escolher outra forma') {
                            botResponse = `Qual a forma de pagamento?`;
                            options = ['Pix', 'Débito', 'Crédito', 'Dinheiro', 'Voltar para Coletar Telefone']; // Changed back option
                            nextState = 'SELECT_PAYMENT_METHOD';
                        } else if (userText === 'Voltar para Coletar Telefone') { // New back option
                            botResponse = 'Voltando para a coleta do telefone. Qual é o seu número de telefone para contato?';
                            nextState = 'COLLECT_PHONE';
                        } else {
                            botResponse = 'Desculpe, não entendi. Por favor, escolha uma das opções.';
                            options = ['Sim, confirmar pagamento', 'Não, escolher outra forma', 'Voltar para Coletar Telefone'];
                            nextState = 'CONFIRM_FINAL_PAYMENT';
                        }
                        break;

                    case 'ORDER_CONFIRMATION': // This state is now just for final display before sending
                        botResponse = 'Seu pedido está pronto. Deseja confirmar ou fazer alguma alteração?';
                        options = ['Confirmar Pedido', 'Editar Pedido', 'Cancelar Pedido', 'Voltar para Coletar Telefone'];
                        nextState = 'ORDER_CONFIRMATION_ACTION';
                        break;

                    case 'ORDER_CONFIRMATION_ACTION':
                        if (userText === 'Confirmar Pedido') {
                            botResponse = 'Por favor, clique no botão "Enviar Pedido via WhatsApp" abaixo para finalizar.';
                            nextState = 'ORDER_CONFIRMATION';
                        } else if (userText === 'Editar Pedido') {
                            botResponse = 'Certo, vamos editar o pedido. O que você gostaria de mudar ou adicionar?';
                            setCurrentOrder(prev => ({ ...prev, items: [], isOrderComplete: false, currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, paymentMethod: '', finalOrderTotal: 0, isDeliverySelected: false, tempSelectedToppings: [] })); // Reset all item-related states
                            options = ['Sorvete de Massa', 'Picolé', 'Açaí', 'Milkshake', 'Voltar ao Início'];
                            nextState = 'SELECT_PRODUCT_TYPE';
                        } else if (userText === 'Cancelar Pedido') {
                            botResponse = 'Pedido cancelado. Posso ajudar com mais alguma coisa?';
                            setCurrentOrder({
                                items: [], customerName: '', deliveryAddress: '', phoneNumber: '', isOrderComplete: false,
                                currentItemType: '', currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemQuantity: 0, currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, paymentMethod: '', finalOrderTotal: 0, isDeliverySelected: false, tempSelectedToppings: [],
                            });
                            options = ['Fazer um Pedido'];
                            nextState = 'SELECT_ACTION';
                        } else {
                            botResponse = 'Desculpe, não entendi. Por favor, escolha uma das opções.';
                            options = ['Confirmar Pedido', 'Editar Pedido', 'Cancelar Pedido', 'Voltar para Coletar Telefone'];
                            nextState = 'ORDER_CONFIRMATION_ACTION';
                        }
                        break;

                    default:
                        botResponse = 'Desculpe, algo deu errado. Vamos começar de novo.';
                        options = ['Fazer um Pedido', 'Quero uma Sugestão ✨']; // Removed Calcular Frete
                        nextState = 'SELECT_ACTION';
                        break;
                }
                return { botResponse, nextState, options };
            };

            const sendMessage = async (text) => {
                setMessages((prevMessages) => [...prevMessages, { sender: 'user', text }]);
                setUserInput('');
                setIsLoading(true);

                const { botResponse, nextState, options } = await getBotResponse(text, conversationState);
                
                // Simulate bot thinking time for a better UX
                setTimeout(() => {
                    setMessages((prevMessages) => [...prevMessages, { sender: 'bot', text: botResponse, options: options }]);
                    setConversationState(nextState);
                    setIsLoading(false);
                }, 500);
            };

            const handleSendMessage = (e) => {
                e.preventDefault();
                if (userInput.trim()) {
                    sendMessage(userInput.trim());
                }
            };
            
            const handleOptionClick = (optionText) => {
                sendMessage(optionText);
            };

            const handleSendOrder = () => {
                if (!currentOrder.isOrderComplete) return;

                // Prepare and send the WhatsApp message
                let orderSummaryText = `Olá, Delicias GELADA'S!\n\n`;
                orderSummaryText += `Gostaria de fazer o seguinte pedido:\n`;

                currentOrder.items.forEach((item, index) => {
                    let itemDescription = `• ${item.quantidade}x ${item.produto} ${item.sabor}`;
                    if (item.precoUnitario) {
                        itemDescription += ` (R$ ${item.precoUnitario.toFixed(2).replace('.', ',')}/un)`;
                    }
                    orderSummaryText += `${itemDescription}\n`;
                });

                orderSummaryText += `\n*Detalhes do Cliente:*\n`;
                orderSummaryText += `Nome: ${currentOrder.customerName}\n`;
                orderSummaryText += `Endereço: ${currentOrder.deliveryAddress}\n`;
                orderSummaryText += `Telefone: ${currentOrder.phoneNumber}\n`;
                
                if (currentOrder.isDeliverySelected && currentOrder.deliveryAddress !== 'Retirada na Loja') {
                    orderSummaryText += `**Frete a verificar.**\n`;
                }

                orderSummaryText += `\n*Forma de Pagamento:* ${currentOrder.paymentMethod}\n`;
                
                let paymentFeeText = '';
                if (currentOrder.paymentMethod === 'Débito') {
                    paymentFeeText = ` (acréscimo de 2% pela taxa da máquina do cartão)`;
                } else if (currentOrder.paymentMethod === 'Crédito') {
                    paymentFeeText = ` (acréscimo de 6% pela taxa da máquina do cartão)`;
                }
                orderSummaryText += `*Total do Pedido: R$ ${currentOrder.finalOrderTotal.toFixed(2).replace('.', ',')}*${paymentFeeText}\n`;
                orderSummaryText += `\nObrigado!`;

                // For WhatsApp, replace newlines with %0A
                const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderSummaryText)}`;
                window.open(whatsappUrl, '_blank');

                // Reset order and conversation state after sending
                setCurrentOrder({
                    items: [], customerName: '', deliveryAddress: '', phoneNumber: '', isOrderComplete: false,
                    currentItemType: '', currentItemBase: '', currentItemContainer: '', currentItemFlavor: '', currentItemQuantity: 0, currentItemPrice: 0, currentItemToppings: '', currentItemToppingsPrice: 0, currentItemTotalPrice: 0, paymentMethod: '', finalOrderTotal: 0, isDeliverySelected: false, tempSelectedToppings: [],
                });
                setMessages([]); // Clear chat history for a fresh start
                setConversationState('START'); // Reset to start for a new order
                // Trigger initial message after reset
                setTimeout(async () => {
                    const { botResponse, nextState, options } = await getBotResponse('', 'START');
                    setMessages([{ sender: 'bot', text: botResponse, options: options }]);
                    setConversationState(nextState);
                }, 1000); // Small delay to allow WhatsApp redirect
            };
            
            const isInputDisabled = isLoading || (messages.length > 0 && messages[messages.length - 1].options && messages[messages.length - 1].options.length > 0 && conversationState !== 'SELECT_QUANTITY' && conversationState !== 'COLLECT_NAME' && conversationState !== 'COLLECT_DELIVERY_ADDRESS' && conversationState !== 'COLLECT_PHONE' && conversationState !== 'SUGGEST_ORDER_ACTION') || currentOrder.isOrderComplete;

            return (
                <div className="flex flex-col h-screen antialiased text-gray-800">
                    <header className="bg-[#4A574F] text-white p-4 flex items-center justify-between shadow-lg rounded-b-2xl">
                        <div className="flex items-center">
                            <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center mr-4 overflow-hidden border-2 border-[#A5D6A7] shadow-md">
                                <img
                                    alt="Delicias GELADA'S Logo"
                                    className="w-full h-full object-cover"
                                    src="https://storage.googleapis.com/gemini-generated-images-web/images/iStock-855447930.jpg-74ee8ee5-12da-41a2-b0bd-b16f3efd1cc6"
                                    onError={(e) => { e.target.src = 'https://placehold.co/48x48/ffffff/333333?text=DG'; }}
                                />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold">Delicias GELADA'S</h1>
                                <p className="text-xs text-[#C8E6C9]">Online</p>
                            </div>
                        </div>
                        {/* WhatsApp-like menu icon (three dots) */}
                        <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                    </header>

                    <main className="flex-1 p-4 overflow-y-auto chat-background">
                        <div className="space-y-4">
                            {messages.map((msg, index) => (
                                <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`relative max-w-md px-4 py-3 rounded-2xl shadow-md transition-all duration-300 ease-in-out ${
                                        msg.sender === 'user'
                                            ? 'bg-[#4A574F] text-white rounded-br-none message-tail-user'
                                            : 'bg-white text-gray-800 rounded-bl-none message-tail-bot'
                                    }`}>
                                        <p className="text-sm leading-relaxed" dangerouslySetInnerHTML={{ __html: msg.text.replace(/\n/g, '<br />') }} />
                                        {/* Only render options if this is the last message AND it's from the bot */}
                                        {index === messages.length - 1 && msg.options && msg.options.length > 0 && msg.sender === 'bot' && (
                                            <div className="flex flex-wrap gap-2 mt-3">
                                                {msg.options.map((option, optIndex) => (
                                                    <button
                                                        key={optIndex}
                                                        onClick={() => handleOptionClick(option)}
                                                        className={`px-4 py-1.5 rounded-full transition duration-300 text-sm font-medium shadow-sm hover:shadow-md
                                                            ${currentOrder.tempSelectedToppings.includes(option) ? 'bg-[#2E7D32] text-white' : 'bg-[#C8E6C9] text-[#2E7D32] hover:bg-[#A5D6A7]'}`
                                                        }
                                                    >
                                                        {option}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="relative max-w-md px-4 py-3 rounded-2xl bg-white text-gray-800 rounded-bl-none shadow-lg message-tail-bot">
                                        <div className="flex items-center space-x-2">
                                            <div className="w-2.5 h-2.5 bg-gray-300 rounded-full animate-pulse-dot"></div>
                                            <div className="w-2.5 h-2.5 bg-gray-300 rounded-full animate-pulse-dot"></div>
                                            <div className="w-2.5 h-2.5 bg-gray-300 rounded-full animate-pulse-dot"></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                    </main>
                    
                    {currentOrder.isOrderComplete ? (
                        <footer className="p-4 bg-white border-t-2 border-[#4A574F] shadow-xl rounded-t-2xl">
                            <h3 className="text-lg font-bold text-gray-800 mb-2">✅ Pedido Pronto!</h3>
                            <div className="text-sm text-gray-600 mb-4 p-4 bg-[#E0F0E0] rounded-xl border border-[#A5D6A7] shadow-inner">
                                <p className="font-semibold mb-1">Resumo:</p>
                                {currentOrder.items.map((item, index) => (
                                    <p key={index}>- {item.quantidade}x {item.produto} {item.sabor} {item.precoUnitario ? `(R$ ${item.precoUnitario.toFixed(2).replace('.', ',')}/un)` : ''}</p>
                                ))}
                                <p className="mt-2"><b>Cliente:</b> {currentOrder.customerName}</p>
                                <p><b>Contato:</b> {currentOrder.phoneNumber}</p>
                                <p><b>Entrega:</b> {currentOrder.deliveryAddress}</p>
                                {currentOrder.isDeliverySelected && currentOrder.deliveryAddress !== 'Retirada na Loja' && (
                                    <p className="mt-1 font-bold text-red-600">Frete a verificar com o fabricante.</p>
                                )}
                                <p className="mt-2"><b>Forma de Pagamento:</b> {currentOrder.paymentMethod}</p>
                                {currentOrder.paymentMethod === 'Débito' && <p className="text-xs text-gray-500">(Acréscimo de 2% pela taxa da máquina do cartão)</p>}
                                {currentOrder.paymentMethod === 'Crédito' && <p className="text-xs text-gray-500">(Acréscimo de 6% pela taxa da máquina do cartão)</p>}
                                <p className="mt-2 text-lg font-bold text-[#2E7D32]">Total: R$ {currentOrder.finalOrderTotal.toFixed(2).replace('.', ',')}</p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-2">
                                <button
                                    onClick={handleSendOrder}
                                    className="w-full p-3 bg-[#4A574F] text-white rounded-lg shadow-lg hover:bg-[#3A433D] focus:outline-none focus:ring-2 focus:ring-[#66BB6A] focus:ring-offset-2 transition duration-300 font-bold flex items-center justify-center gap-2 transform hover:scale-105"
                                >
                                    Enviar Pedido via WhatsApp
                                    <span className="w-6 h-6">
                                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.45 16.73L2.05 22L7.31 20.6C8.69 21.36 10.32 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M12.04 3.62C16.63 3.62 20.33 7.32 20.33 11.91C20.33 16.5 16.63 20.2 12.04 20.2C10.49 20.2 9.03 19.78 7.8 19.05L7.29 18.73L4.85 19.38L5.53 17L5.2 16.48C4.41 15.15 3.96 13.57 3.96 11.91C3.96 7.32 7.66 3.62 12.04 3.62M9.03 7.23C8.83 7.23 8.66 7.24 8.51 7.24C8.21 7.24 7.91 7.33 7.67 7.61C7.42 7.89 6.81 8.46 6.81 9.58C6.81 10.7 7.7 11.75 7.85 11.92C8 12.09 9.35 14.33 11.69 15.26C13.62 16.03 14.04 15.86 14.38 15.81C15.2 15.69 15.93 15.03 16.2 14.28C16.48 13.53 16.48 12.93 16.39 12.79C16.31 12.65 16.14 12.58 15.88 12.44C15.63 12.31 14.45 11.74 14.21 11.65C13.96 11.56 13.8 11.51 13.64 11.79C13.48 12.07 13.06 12.58 12.92 12.75C12.77 12.92 12.63 12.94 12.38 12.81C12.13 12.67 11.29 12.39 10.29 11.5C9.52 10.82 9.03 10.01 8.86 9.73C8.69 9.45 8.84 9.32 8.98 9.18C9.11 9.06 9.26 8.87 9.38 8.73C9.5 8.59 9.55 8.48 9.64 8.3C9.72 8.12 9.64 7.95 9.55 7.81C9.47 7.68 9.03 6.5 9.03 7.23Z" /></svg>
                                    </span>
                                </button>
                            </div>
                        </footer>
                    ) : (
                        <footer className="p-4 bg-white border-t border-gray-200 shadow-xl rounded-t-2xl">
                            <form onSubmit={handleSendMessage} className="flex items-center gap-3">
                                <input
                                    type="text"
                                    value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    placeholder={isInputDisabled ? "Escolha uma opção acima..." : "Digite sua mensagem..."}
                                    className="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#4A574F] transition duration-300 text-gray-700 placeholder-gray-400 shadow-sm"
                                    disabled={isInputDisabled}
                                />
                                <button
                                    type="submit"
                                    className="p-3 bg-[#4A574F] text-white rounded-full shadow-lg hover:bg-[#3A433D] focus:outline-none focus:ring-2 focus:ring-[#66BB6A] focus:ring-offset-2 transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none"
                                    disabled={isLoading || !userInput.trim()}
                                >
                                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.684-.275a1 1 0 00.57-1.391L10.28 9.873a1 1 0 011.44-1.44l6.76 6.76a1 1 0 001.39-1.168l-14-7z"></path></svg>
                                </button>
                            </form>
                        </footer>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
